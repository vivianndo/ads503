---
title: "The Diabetes Project"
author: "Vivian Do, Bethany Wang, Dennis Myasnyankin"
date: "2023-06-05"
output: html_document
Reference: https://www.hindawi.com/journals/bmri/2014/781670/
---

### Update Notes:
#### 6-4 Bethany
* Layout the project
* Did initial version of EDA

#### 6-6 Vivian 
* Modified some initial steps of checking and classifying features
* Define response variable and convert to binary levels
* Separate numerical and categorical variables
* Added boxplots of numerical predictors and the target variable

#### 6-7 Bethany
* Summarized and analyzed the degenerated features
* Completed histograms for all the other categorical features
* Added another implementation of the boxplots in section 1.9
* Did most of the data preprocessing
* Not sure why the data imputing does not work?
* Question/suggetion:  move the factoring the categorical variables to preprocessing section

#### 6-8 Bethany
* Cleaned up and reorganized EDA
* Minor fixes in data preprocessing

### 6-12 Vivian
* Create frequeny counts, proportions for each categorical variable vs. response
* Create barcharts w/ proportions for all categorical variables + observed findings.
* Fix data import to replace all "?" string with NA

### 1. Exploratory Data Analysis<br><br>

#### <b>1.1 Import and check the Data</b><br><br>

```{r}
#Read in data, replace "?" with NA values 
df <- read.csv(file = "diabetic_data.csv", na.strings=c("?"))
dim(df)
str(df)
```
* There are 101766 data records with 50 features

#### <b>1.2 Convert categorical variables into factors</b><br><br>

* All feature that are recorded as chr type are categorical variables 
* admission_type_id, discharge_disposition_id, admission_source_id are recorded as int, but should be taken as categorical variables.

```{r}
#Convert categorical variables into factors (according to Table 1 https://www.hindawi.com/journals/bmri/2014/781670/tab1/)
df[sapply(df, is.character)] <- lapply(df[sapply(df, is.character)], 
                                       as.factor)

df$admission_type_id <- as.factor(df$admission_type_id)
df$discharge_disposition_id <- as.factor(df$discharge_disposition_id)
df$admission_source_id <- as.factor(df$admission_source_id)

```

* All categorical variables have been concerted into factors


#### <br><b>1.3 Classify features</b><br><br>


* Subset numerical and categorical features

```{r message=FALSE, warning=FALSE}
# Subset numerical and categorical features into new data frames
library(dplyr)
df_num <- df %>%  select_if(is.integer)
df_num <- subset(df_num, select = -c(encounter_id, patient_nbr))

df_cat <- df %>% select_if(is.factor)

# Show numerical variables
cat("These are the numerical features:\n", colnames(df_num), "\n\n")

# Show categorical variables
cat("These are the categorical features:\n", colnames(df_cat), "\n\n")
```
```{r message=FALSE, warning=FALSE}
library(dplyr)
n_distinct(df$encounter_id)
n_distinct(df$patient_nbr)
```

* Out of 101766 encounters, there were 71518 (new) patients admitted while 30248 encounters were readmissions. 
* After printing the unique values, we see encounter_id and patient_nbr are just some identifiers, not useful features. We do not need to further explore them. 

#### <br><b>1.4 Explore and revalue the response variable</b><br><br>

* We use "readmitted" as our response variable 

```{r}
# Show readmission counts
table(df$readmitted)
```

* 11357 patient records were readmitted within 30 days, 35535 patient records were readmitted after 30 days, and 54863 patient records were not readmitted.

* We will combine the categories '<30' and '>30' to account for all patient records who were readmitted.Thus, our response variable will be binary: Yes for patients who were readmitted, and No if the patient was not readmitted. 

```{r message=FALSE, warning=FALSE}
library(plyr)
# Combine all readmissions
revalue(df$readmitted, c("<30" = "YES")) -> df$readmitted
revalue(df$readmitted, c(">30" = "YES")) -> df$readmitted

# Show readmission counts using binary levels
table(df$readmitted)

```
* After revalue response "<30" and ">30" to "YES", there are 46902 instances of "YES" and 54864 instances of "NO"

#### <br><b>1.5 Check for missing values</b><br><br>

```{r}
# Check null values

#Change '?' into NA for ease of analysis
df[df=='?'] <- NA 

#summary(df)

#Show null counts
null_counts <- sort(colSums(is.na(df)), decreasing=TRUE)
null_counts

#Show proportion of null counts
head(prop.table(null_counts), 10)
```

* The following predictors contain a significant number of null values: 'weight' (98569, 52%), medical_specialty (49949, 26%), 'payer_code' ( 40256, 21%), and 'race' (2273, 1%). 


#### <br><b>1.6 Statistics of the numerical variables</b><br><br>

```{r}
summary(df_num)
```

#### <br><b>1.7 Correlations of the numerical variables</b><br><br>

* Find Correlations of numerical features

```{r message=FALSE, warning=FALSE}

library(corrplot)
correlations <- cor(df_num)

# Correlation plot
corrplot(correlations, order = "hclust")
```

#### <br><b>1.8 Distribution of the numerical variables</b><br><br>

```{r out.width="1000", out.height="1000", message=FALSE, warning=FALSE}
library(Hmisc)
hist.data.frame(df_num)
```

```{r out.width="1000", out.height="1000"}
#pairs(df_num)
```


#### <br><b>1.9 Check degenerated features</b><br><br>

```{r message=FALSE, warning=FALSE}

library(caret)

degenerateCols <- nearZeroVar(df)
degenerateColNames <- colnames(df[degenerateCols])
degenerateColNum <- length(degenerateColNames)

cat("These are ", degenerateColNum, " degenerated predictors:\n", degenerateColNames)

#subset the degenerated predictors
df_degenerated <- df[,degenerateColNames]
colnames(df_degenerated)

# Check the distribution of the degenerated predictors
summary(df_degenerated)
```

* These are 19 degenerated predictors that show near-zero variance.

#### <br><b>1.10 Distribution of the categorical variables</b><br><br>

```{r out.width="1200", out.height="1200"}
par(mfrow = c(3,4))

barplot(table(df$age), main="Distribution of Age", 
        xlab="Age", ylab="Count", col="blue")

barplot(table(df$race), main="Distribution of Race", 
        xlab="Race", ylab="Count", col="orange")

barplot(table(df$gender), main="Distribution of Gender", 
        xlab="Gender", ylab="Count", col="lightblue")

barplot(table(df$admission_type_id), main="Distribution of admission_type_id", 
        xlab="admission_type_id", ylab="Count", col="blue")

barplot(table(df$change), main="Distribution of change", 
        xlab="Race", ylab="Count", col="orange")

barplot(table(df$admission_source_id), main="Distribution of admission_source_id", 
        xlab="admission_source_id", ylab="Count", col="lightblue")

barplot(table(df$A1Cresult), main="Distribution of A1Cresult", 
        xlab="A1Cresult", ylab="Count", col="green")

barplot(table(df$diabetesMed), main="Distribution of diabetesMed", 
        xlab="diabetesMed", ylab="Count", col="lightgreen")

barplot(table(df$weight), main="Distribution of readmitted", 
        xlab="readmitted", ylab="Count", col="purple")

barplot(table(df$diag_1), main="Distribution of diag_1", 
        xlab="diag_1", ylab="Count", col="orange")

barplot(table(df$diag_2), main="Distribution of diag_2", 
        xlab="diag_2", ylab="Count", col="lightblue")

barplot(table(df$diag_3), main="Distribution of diag_3", 
        xlab="diag_3", ylab="Count", col="green")
```


```{r out.width="1200", out.height="1200"}
par(mfrow = c(3,4))

barplot(table(df$payer_code), main="Distribution of payer_code", 
        xlab="payer_code", ylab="Count", col="blue")

barplot(table(df$medical_specialty), main="Distribution of medical_specialty", 
        xlab="medical_specialty", ylab="Count", col="orange")

barplot(table(df$A1Cresult), main="Distribution of A1Cresult", 
        xlab="A1Cresult", ylab="Count", col="green")

barplot(table(df$metformin), main="Distribution of metformin", 
        xlab="metformin", ylab="Count", col="cyan")

barplot(table(df$glipizide), main="Distribution of glipizide", 
        xlab="glipizide", ylab="Count", col="blue")

barplot(table(df$glyburide), main="Distribution of glyburide", 
        xlab="glyburide", ylab="Count", col="orange")

barplot(table(df$pioglitazone), main="Distribution of pioglitazone", 
        xlab="pioglitazone", ylab="Count", col="green")

barplot(table(df$rosiglitazone), main="Distribution of rosiglitazone", 
        xlab="rosiglitazone", ylab="Count", col="cyan")

barplot(table(df$insulin), main="Distribution of insulin", 
        xlab="insulin", ylab="Count", col="blue")

barplot(table(df$change), main="Distribution of change", 
        xlab="change", ylab="Count", col="orange")

barplot(table(df$diabetesMed), main="Distribution of diabetesMed", 
        xlab="diabetesMed", ylab="Count", col="green")

#barplot(table(df$medical_specialty), main="Distribution of Race", xlab="Race", ylab="Count", col="cyan")
```


#### <br><b>1.11 Explore the relationship between the numerical predictors and the predicted variable</b><br><br>

```{r out.width="1000", out.height="800"}
par(mfrow = c(2,4))

boxplot(df$time_in_hospital ~ df$readmitted, col="blue")
boxplot(df$num_lab_procedures ~ df$readmitted, col="orange")
boxplot(df$number_diagnoses ~ df$readmitted, col="yellow")

boxplot(df$number_emergency ~ df$readmitted, col="cyan")
boxplot(df$num_medications ~ df$readmitted, col="purple")
boxplot(df$number_inpatient ~ df$readmitted, col="green")
boxplot(df$number_outpatient ~ df$readmitted, col="lightblue")
```

Patients who are readmitted, in general

* Spend more time in the hospital
  
* Have more inpatient visits in the year preceding the encounter
  
* Have more diagnoses entered to the system during their encounter. 

#### <br><b>1.12 Explore the relationship between the categorical predictors and the predicted variable</b><br><br>

```{r}
# Frequency counts
ct_race <- table(df$readmitted, df$race)
ct_gender <- table(df$readmitted, df$gender)
ct_age <- table(df$readmitted, df$age)
ct_weight <- table(df$readmitted, df$weight)
ct_admissionType <- table(df$readmitted, df$admission_type_id)
ct_dischargeID <- table(df$readmitted, df$discharge_disposition_id)
ct_admissionSource <- table(df$readmitted, df$admission_source_id)
ct_payerCode <- table(df$readmitted, df$payer_code)
ct_medSpec <- table(df$readmitted, df$medical_specialty)
ct_A1C <- table(df$readmitted, df$A1Cresult)
ct_metf <- table(df$readmitted, df$metformin)
ct_glipz <- table(df$readmitted, df$glipizide)
ct_glyb <- table(df$readmitted, df$glyburide)
ct_piog <- table(df$readmitted, df$pioglitazone)
ct_rosig <- table(df$readmitted, df$rosiglitazone)
ct_insulin <- table(df$readmitted, df$insulin)
ct_change <- table(df$readmitted, df$change)
ct_diabMeds <- table(df$readmitted, df$diabetesMed)

# Create contingency tables showing proportions 
ct_race1 <- prop.table(table(df$readmitted, df$race),2)
ct_gender1 <- prop.table(table(df$readmitted, df$gender),2)
ct_age1 <- prop.table(table(df$readmitted, df$age),2)
ct_weight1 <- prop.table(table(df$readmitted, df$weight),2)
ct_admissionType1 <- prop.table(table(df$readmitted, df$admission_type_id),2)
ct_dischargeID1 <- prop.table(table(df$readmitted, df$discharge_disposition_id),2)
ct_admissionSource1 <- prop.table(table(df$readmitted, df$admission_source_id),2)
ct_payerCode1 <- prop.table(table(df$readmitted, df$payer_code),2)
ct_medSpec1 <- prop.table(table(df$readmitted, df$medical_specialty),2)
ct_A1C1 <- prop.table(table(df$readmitted, df$A1Cresult),2)
ct_metf1 <- prop.table(table(df$readmitted, df$metformin),2)
ct_glipz1 <- prop.table(table(df$readmitted, df$glipizide),2)
ct_glyb1 <- prop.table(table(df$readmitted, df$glyburide),2)
ct_piog1 <- prop.table(table(df$readmitted, df$pioglitazone),2)
ct_rosig1 <- prop.table(table(df$readmitted, df$rosiglitazone),2)
ct_insulin1 <- prop.table(table(df$readmitted, df$insulin),2)
ct_change1 <- prop.table(table(df$readmitted, df$change),2)
ct_diabMeds1 <- prop.table(table(df$readmitted, df$diabetesMed),2)

## Create barplots ##
# Patient Demographics (Legend removed for individual graphs where bars would be blocked)
par(mfrow=c(3,2))
barplot(ct_age1,main="Age Group",xlab="Age Group",ylab="Readmitted",col=c("blue", "orange"))
barplot(ct_race1,main="Race",xlab="Race",ylab="Readmitted",col=c("blue", "orange"),las=2)
barplot(ct_gender1,main="Gender",xlab="Gender",ylab="Readmitted",col=c("blue", "orange"),legend=rownames(ct_gender1))
barplot(ct_payerCode1,main="Payer Code",xlab="Payer Code",ylab="Readmitted",col=c("blue", "orange"),las=2)
barplot(ct_weight1,main="Weight",xlab="Weight (lbs)",ylab="Readmitted",col=c("blue", "orange"),las=2)
barplot(ct_dischargeID1,main="Discharge ID",xlab="Discharge ID",ylab="Readmitted",col=c("blue", "orange"))
```

* Race: Asians were disproportionately less likely to be readmitted. 
* Weight: Patients weighing 0-25 or >200 lbs were disproportionately more likely to be readmitted.
* Discharge ID: Discharge IDs 11, 19, and 20 were disproportionately less likely to be readmitted. Patients with discharge IDs 10,12,15 were disproportionately more likely to be readmitted. 

```{r}
# General encounter information
par(mfrow=c(3,2))
barplot(ct_admissionSource1,main="Admission Source",xlab="Admission Source",ylab="Readmitted",col=c("blue", "orange"),las=2)
barplot(ct_admissionType1,main="Admission Type",xlab="Admission Type",ylab="Readmitted",col=c("blue", "orange"))
barplot(ct_A1C,main="A1C Result",xlab="A1C Result",ylab="Readmitted",col=c("blue", "orange"),legend=rownames(ct_A1C))
barplot(ct_change1,main="Medications Change",xlab="Medications Change",ylab="Readmitted",col=c("blue", "orange"))
barplot(ct_diabMeds1,main="Diabetes Medication",xlab="Diabetes Medication",ylab="Readmitted",col=c("blue", "orange"))
barplot(ct_medSpec1,main="Medical Specialty",xlab="Medical Specialty",ylab="Readmitted",col=c("blue", "orange"),las=2)
```

* Admission Source: Admission sources 11, 13, 14, 25 less likely to be readmitted. 
* Admission Type: Admission type 7 less likely to be readmitted. 
* Medical Specialty: Patients admitted by certain medical specialities were less likely to be readmitted, such as Speech, Psychiatry, and Neurology. 

```{r}
# All medications
par(mfrow=c(3,2))
barplot(ct_glipz1,main="Glipizide ",xlab="Glipizide",ylab="Readmitted",col=c("blue", "orange"))
barplot(ct_glyb1,main="Glyburide",xlab="Glyburide",ylab="Readmitted",col=c("blue", "orange"),legend=rownames(ct_glyb1))
barplot(ct_metf1,main="Metformin",xlab="Metformin",ylab="Readmitted",col=c("blue", "orange"),legend=rownames(ct_metf1))
barplot(ct_insulin1,main="Insulin",xlab="Insulin",ylab="Readmitted",col=c("blue", "orange"))
barplot(ct_piog1,main="Pioglitazone",xlab="Pioglitazone",ylab="Readmitted",col=c("blue", "orange"))
barplot(ct_rosig1,main="Rosiglitazone",xlab="Rosiglitazone",ylab="Readmitted",col=c("blue", "orange"),legend=rownames(ct_rosig1))
```

* Patients who were prescribed a decreased dosage of rosiglitazone were less likely to be readmitted. 
* Besides this, no other significant differences for the change in/prescription of drugs were observed. 


### 2. Data Preprocessing

#### <br><b>2.1 Filter out degenerated predictors</b><br><br>
```{r message=FALSE, warning=FALSE}
# Use nearZeroVar function from caret library to filter out low variance features
df <- df[, -degenerateCols]
dim(df)
colnames(df)
```

#### <br><b>2.2 Remove useless features</b><br><br>

```{r}

df <- subset(df, select = -c(encounter_id, patient_nbr))
dim(df)
```

* There are 30 variables (29 predictors, 1 response variable) remaining after removal of degenerated variables and observational IDs (encounter_id and patient_nbr). 

#### <br><b>2.3 Partition data into training and test datasets using a 70% ratio</b><br><br>

```{r}
# Separate X and Y
dfX <- subset(df, select = -c(readmitted))
dfY <- subset(df, select = c(readmitted))

set.seed(100)

# Partition the dataset
trainRows <- createDataPartition(dfY$readmitted, p = .70, list = FALSE) 

trainX <- dfX[trainRows,]
testX <-  dfX[-trainRows,]

trainY <- dfY[trainRows,]
testY <- dfY[-trainRows,]

dim(trainX)
dim(testX)
```

#### <br><b>2.4 Handle missing values</b><br><br>

```{r}
install.packages("RANN")
library(RANN)
train_null_counts <- sort(colSums(is.na(trainX)), decreasing=TRUE)
head(train_null_counts, 10)

# Impute the missing values in the training set
library(caret)
train_impute <- preProcess(trainX, method=c("knnImpute"))
trainX <- predict(train_impute, trainX)
sum(is.na(trainX))


train_null_counts <- sort(colSums(is.na(trainX)), decreasing=TRUE)
head(train_null_counts, 10)

# Impute the missing values in the test set
testX <- predict(train_impute, testX)

test_null_counts <- sort(colSums(is.na(testX)), decreasing=TRUE)
head(test_null_counts, 10)

```

#### <br><b>2.5 Trandform and standardize features: center and scale</b><br><br>

```{r}
# center and scale the training set
train_tran <- preProcess(trainX, method=c("center", "scale"))
trainX <- predict(train_tran, trainX)

# center and scale the test set
testX <- predict(train_tran, testX)
```

#### <br><b>2.6 PCA Analysis</b><br><br>

```{r}

```


### 3. Modeling

#### <br><b>3.1 </b><br><br>
```{r}

```

#### <br><b>3.2 </b><br><br>
```{r}

```

#### <br><b>3.3 </b><br><br>

```{r}

```

#### <br><b>3.4 </b><br><br>

```{r}

```

#### <br><b>3.5 </b><br><br>

```{r}

```

#### <br><b>3.6 </b><br><br>

```{r}

```

### 4. Conclusion
```{r}

```
