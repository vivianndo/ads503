---
title: "The Diabetes Project"
author: "Vivian Do, Bethany Wang, Dennis Myasnyankin"
date: "2023-06-05"
output: html_document
Reference: https://www.hindawi.com/journals/bmri/2014/781670/
---

### Update Notes:
#### 6-4 Bethany
* Layout the project
* Did initial version of EDA

#### 6-6 Vivian 
* Modified some initial steps of checking and classifying features
* Added boxplots of numerical predictors and the target variable

#### 6-7 Bethany
* Summarized and analyzed the degenerated features
* Completed histograms for all the other categorical features
* Added another implementation of the boxplots in section 1.9
* Did most of the data preprocessing
* Not sure why the data imputing does not work?
* Question/suggetion:  move the factoring the categorical variables to preprocessing section

### 1. Exploratory Data Analysis<br><br>

#### <b>1.1 Import and check the Data</b><br><br>

```{r}
df <- read.csv(file = "diabetic_data.csv")
dim(df)
str(df)
```
* There are 101766 data records with 50 features

#### <b>1.2 Convert categorical variables into factors</b><br><br>

* All feature that are recorded as chr type are categorical variables 
* admission_type_id, discharge_disposition_id, admission_source_id are recorded as int, but should be taken as categorical variables.

```{r}
#Convert categorical variables into factors (according to Table 1 https://www.hindawi.com/journals/bmri/2014/781670/tab1/)
df[sapply(df, is.character)] <- lapply(df[sapply(df, is.character)], 
                                       as.factor)

df$admission_type_id <- as.factor(df$admission_type_id)
df$discharge_disposition_id <- as.factor(df$discharge_disposition_id)
df$admission_source_id <- as.factor(df$admission_source_id)

```

* All categorical variables have been concerted into factors


#### <br><b>1.3 Classify features</b><br><br>

* Subset numerical and categorical features

```{r message=FALSE, warning=FALSE}
# Subset numerical and categorical features into new data frames
library(dplyr)
df_num <- df_pred %>%  select_if(is.integer)
df_cat <- df_pred %>% select_if(is.factor)

# Show numerical variables
cat("These are the numerical features:\n", colnames(df_num), "\n")

# Show categorical variables
cat("These are the categorical features:\n", colnames(df_cat), "\n")
```

```{r}
#Separate numerical features into a new frame
#df_num <-subset(df, select = c(time_in_hospital, num_lab_procedures, num_procedures, num_medications, number_outpatient, #number_emergency, number_inpatient, number_diagnoses))

#cat("These are the numerical features:\n", colnames(df_num))

#Separate categorical features into a new frame
#df_cat <- subset(df, select = -c(time_in_hospital, num_lab_procedures, num_procedures, num_medications, number_outpatient, number_emergency, number_inpatient, number_diagnoses))

#cat("These are the categorical features:\n", colnames(df_cat))
```


## Define predictors and response variable ##
```{r}
# Define the response variable as 'readmitted'
df_response <- subset(df, select=c(readmitted))

# All other variables are predictors
df_pred <- subset(df, select=-c(readmitted))
```

## Explore response variable ##
```{r}
# Show readmission counts
table(df_response)
```

11357 patient records were readmitted within 30 days, 35535 patient records were readmitted after 30 days, and 54863 patient records were not readmitted.

We will combine the categories '<30' and '>30' to account for all patient records who were readmitted.Thus, our response variable will be binary: Yes for patients who were readmitted, and No if the patient was not readmitted. 

```{r}
library(plyr)
# Combine all readmissions
revalue(df_response$readmitted, c("<30" = "YES")) -> df_response$readmitted
revalue(df_response$readmitted, c(">30" = "YES")) -> df_response$readmitted

revalue(df$readmitted, c("<30" = "YES")) -> df$readmitted
revalue(df$readmitted, c(">30" = "YES")) -> df$readmitted

# Show readmission counts using binary levels
table(df_response)
```

#### <br><b>1.3 Check for missing values</b><br><br>

```{r}
# Check null values

#Change '?' into NA for ease of analysis
df[df=='?'] <- NA 
summary(df)
#Show null counts
null_counts <- sort(colSums(is.na(df)), decreasing=TRUE)
null_counts

#Show proportion of null counts
head(prop.table(null_counts), 10)
```
* The following predictors contain a significant number of null values: 'weight' (98569, 52%), medical_specialty (49949, 26%), 'payer_code' ( 40256, 21%), and 'race' (2273, 1%). 


#### <br><b>1.4 Check degenerated features</b><br><br>

```{r message=FALSE, warning=FALSE}

library(caret)

degenerateCols <- nearZeroVar(df)
degenerateColNames <- colnames(df[degenerateCols])
cat("There are the degenerated predictors:\n", degenerateColNames)

#subset the degenerated predictors
df_degenerated <- df[,degenerateColNames]
colnames(df_degenerated)

# Check the distribution of the degenerated predictors
summary(df_degenerated)
```
* By checking the distribution of the degenerated predictors, we confirmed that those predictors have values that show near-zero variance. They are not useful features and will be excluded from further analysis.

#### <br><b>1.5 Statistics of the numerical variables</b><br><br>

```{r}
summary(df_num)
```

#### <br><b>1.6 Correlations of the numerical variables</b><br><br>

* Find Correlations of numerical features
```{r message=FALSE, warning=FALSE}

library(corrplot)
correlations <- cor(df_num)

# Correlation plot
corrplot(correlations, order = "hclust")
```

#### <br><b>1.7 Distribution of the numerical variables</b><br><br>

```{r out.width="1000", out.height="1000", message=FALSE, warning=FALSE}
library(Hmisc)
hist.data.frame(df_num)
```

```{r out.width="1000", out.height="1000"}
#pairs(df_num)
```

#### <br><b>1.8 Explore the relationship between the numerical predictors and the predicted variable</b><br><br>

```{r}
library(ggplot2)

ggplot(df, aes(readmitted,time_in_hospital)) + geom_boxplot(fill = "blue") + labs(title = "Time in Hospital")
ggplot(df, aes(readmitted,num_lab_procedures)) + geom_boxplot(fill = "blue") + labs(title = "Number of Lab Procedures")
ggplot(df, aes(readmitted,num_procedures)) + geom_boxplot(fill = "blue") + labs(title = "Number of Procedures")
ggplot(df, aes(readmitted,num_medications)) + geom_boxplot(fill = "blue") + labs(title = "Number of Medications")
ggplot(df, aes(readmitted,number_outpatient)) + geom_boxplot(fill = "blue") + labs(title = "Number of Outpatient Visits")
ggplot(df, aes(readmitted,number_emergency)) + geom_boxplot(fill = "blue") + labs(title = "Number of Emergency Visits")
ggplot(df, aes(readmitted,number_inpatient)) + geom_boxplot(fill = "blue") + labs(title = "Number of Inpatient Visits")
ggplot(df, aes(readmitted,number_diagnoses)) + geom_boxplot(fill = "blue") + labs(title = "Number of Diagnoses")

```

Patients who are readmitted, in general

* Spend more time in the hospital
  
* Have more inpatient visits in the year preceding the encounter
  
* Have more diagnoses entered to the system during their encounter. 



```{r out.width="1000", out.height="800"}
par(mfrow = c(2,4))

boxplot(df$time_in_hospital ~ df$readmitted, col="blue")
boxplot(df$num_lab_procedures ~ df$readmitted, col="orange")
boxplot(df$number_diagnoses ~ df$readmitted, col="yellow")

boxplot(df$number_emergency ~ df$readmitted, col="cyan")
boxplot(df$num_medications ~ df$readmitted, col="purple")
boxplot(df$number_inpatient ~ df$readmitted, col="green")
boxplot(df$number_outpatient ~ df$readmitted, col="lightblue")
```
#### <br><b>1.9 Distribution of the categorical variables</b><br><br>

```{r message=FALSE, warning=FALSE}
library(dplyr)
n_distinct(df$encounter_id)
n_distinct(df$patient_nbr)
```

* Out of 101766 encounters, there were 71518 (new) patients admitted while 30248 encounters were readmissions. 

* After printing the unique values, we see encounter_id and patient_nbr are just some identifiers, not useful features. We do not need to further explore them. 

```{r out.width="1200", out.height="1200"}
par(mfrow = c(3,4))

barplot(table(df$age), main="Distribution of Age", 
        xlab="Age", ylab="Count", col="blue")

barplot(table(df$race), main="Distribution of Race", 
        xlab="Race", ylab="Count", col="orange")

barplot(table(df$gender), main="Distribution of Gender", 
        xlab="Gender", ylab="Count", col="lightblue")

barplot(table(df$admission_type_id), main="Distribution of admission_type_id", 
        xlab="admission_type_id", ylab="Count", col="blue")

barplot(table(df$change), main="Distribution of change", 
        xlab="Race", ylab="Count", col="orange")

barplot(table(df$admission_source_id), main="Distribution of admission_source_id", 
        xlab="admission_source_id", ylab="Count", col="lightblue")

barplot(table(df$A1Cresult), main="Distribution of A1Cresult", 
        xlab="A1Cresult", ylab="Count", col="green")

barplot(table(df$diabetesMed), main="Distribution of diabetesMed", 
        xlab="diabetesMed", ylab="Count", col="lightgreen")

barplot(table(df$weight), main="Distribution of readmitted", 
        xlab="readmitted", ylab="Count", col="purple")

barplot(table(df$diag_1), main="Distribution of diag_1", 
        xlab="diag_1", ylab="Count", col="orange")

barplot(table(df$diag_2), main="Distribution of diag_2", 
        xlab="diag_2", ylab="Count", col="lightblue")

barplot(table(df$diag_3), main="Distribution of diag_3", 
        xlab="diag_3", ylab="Count", col="green")
```


```{r out.width="1200", out.height="1200"}
par(mfrow = c(3,4))

barplot(table(df$payer_code), main="Distribution of payer_code", 
        xlab="payer_code", ylab="Count", col="blue")

barplot(table(df$medical_specialty), main="Distribution of medical_specialty", 
        xlab="medical_specialty", ylab="Count", col="orange")

barplot(table(df$A1Cresult), main="Distribution of A1Cresult", 
        xlab="A1Cresult", ylab="Count", col="green")

barplot(table(df$metformin), main="Distribution of metformin", 
        xlab="metformin", ylab="Count", col="cyan")

barplot(table(df$glipizide), main="Distribution of glipizide", 
        xlab="glipizide", ylab="Count", col="blue")

barplot(table(df$glyburide), main="Distribution of glyburide", 
        xlab="glyburide", ylab="Count", col="orange")

barplot(table(df$pioglitazone), main="Distribution of pioglitazone", 
        xlab="pioglitazone", ylab="Count", col="green")

barplot(table(df$rosiglitazone), main="Distribution of rosiglitazone", 
        xlab="rosiglitazone", ylab="Count", col="cyan")

barplot(table(df$insulin), main="Distribution of insulin", 
        xlab="insulin", ylab="Count", col="blue")

barplot(table(df$change), main="Distribution of change", 
        xlab="change", ylab="Count", col="orange")

barplot(table(df$diabetesMed), main="Distribution of diabetesMed", 
        xlab="diabetesMed", ylab="Count", col="green")

#barplot(table(df$medical_specialty), main="Distribution of Race", xlab="Race", ylab="Count", col="cyan")
```

#### <br><b>1.10 Explore the relationship between the categorical predictors and the predicted variable</b><br><br>

```{r}

```

### 2. Data Preprocessing

#### <br><b>2.1 Filter out degenerated predictors</b><br><br>
```{r message=FALSE, warning=FALSE}
# Use nearZeroVar function from caret library to filter out low variance features
df <- df[, -degenerateCols]
dim(df)
colnames(df)
```

#### <br><b>2.2 Remove useless features</b><br><br>

```{r}

df <- subset(df, select = -c(encounter_id, patient_nbr, payer_code))
dim(df)
```

#### <br><b>2.3 Partition data into training and test datasets using a 70% ratio</b><br><br>

```{r}
# Separate X and Y
dfX <- subset(df, select = -c(readmitted))
dfY <- subset(df, select = c(readmitted))

set.seed(100)

# Partition the dataset
trainRows <- createDataPartition(dfY$readmitted, p = .70, list = FALSE) 

trainX <- dfX[trainRows,]
testX <-  dfX[-trainRows,]

trainY <- dfY[trainRows,]
testY <- dfY[-trainRows,]

dim(trainX)
dim(testX)
```

#### <br><b>2.4 Handle missing values</b><br><br>

```{r}

train_null_counts <- sort(colSums(is.na(trainX)), decreasing=TRUE)
head(train_null_counts, 10)

# Impute the missing values in the training set
trainimp <- preProcess(trainX, method=c("medianImpute"))
trainX1 <- predict(trainimp, trainX)

train_null_counts <- sort(colSums(is.na(trainX1)), decreasing=TRUE)
head(train_null_counts, 10)

# Impute the missing values in the training set
testimp <- preProcess(testX, method=c("medianImpute"))
testX1 <- predict(testimp, testX)

test_null_counts <- sort(colSums(is.na(testX1)), decreasing=TRUE)
head(test_null_counts, 10)

```


#### <br><b>2.5 Factor the categorical variables</b><br><br>

```{r}

```


#### <br><b>2.6 Trandform and standardize features: center and scale</b><br><br>

```{r}
# center and scale the training set
trainimp <- preProcess(trainX, method=c("center", "scale"))
trainX <- predict(trainimp, trainX)


# center and scale the test set
testimp <- preProcess(testX, method=c("center", "scale"))
testX <- predict(testimp, testX)
```

#### <br><b>2.7 PCA Analysis</b><br><br>

```{r}

```


### 3. Modeling

#### <br><b>3.1 </b><br><br>
```{r}

```

#### <br><b>3.2 </b><br><br>
```{r}

```

#### <br><b>3.3 </b><br><br>

```{r}

```

#### <br><b>3.4 </b><br><br>

```{r}

```

#### <br><b>3.5 </b><br><br>

```{r}

```

#### <br><b>3.6 </b><br><br>

```{r}

```

### 4. Conclusion
```{r}

```
